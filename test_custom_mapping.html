<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自定义字段映射Excel导入测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.secondary {
            background-color: #008CBA;
        }
        .button.secondary:hover {
            background-color: #007B9A;
        }
        .info {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .file-input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .columns-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .columns-list ul {
            columns: 3;
            column-gap: 20px;
            list-style-type: none;
            padding: 0;
        }
        .columns-list li {
            margin: 5px 0;
            padding: 2px 5px;
            background-color: white;
            border-radius: 3px;
            break-inside: avoid;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .result-details {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>自定义字段映射Excel导入测试</h1>
    
    <div class="section">
        <h3>功能说明</h3>
        <div class="info">
            <p><strong>新功能特点：</strong></p>
            <ul>
                <li>支持Excel列名与数据库字段的灵活映射</li>
                <li>支持88个时间字段（time1-time88）的多种命名格式</li>
                <li>自动识别列名格式：如"第1分钟"、"时间1"、"T1"、"1分钟"等</li>
                <li>提供详细的导入结果反馈和错误信息</li>
                <li>支持大文件批量处理</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>支持的Excel列名</h3>
        <button class="button secondary" onclick="loadSupportedColumns()">获取支持的列名</button>
        <div id="supportedColumns" class="columns-list" style="display:none;">
            <p>加载中...</p>
        </div>
    </div>

    <div class="section">
        <h3>Excel文件导入测试</h3>
        <div>
            <label for="fileInput">选择Excel文件：</label>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
        </div>
        <div>
            <button class="button" onclick="importExcel()">导入Excel文件</button>
            <button class="button secondary" onclick="createSampleExcel()">创建示例Excel文件</button>
        </div>
    </div>

    <div class="section">
        <h3>导入结果</h3>
        <div id="importResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/medicinalPlants';

        // 加载支持的列名
        function loadSupportedColumns() {
            const container = document.getElementById('supportedColumns');
            container.style.display = 'block';
            container.innerHTML = '<p>加载中...</p>';

            fetch(`${API_BASE}/getSupportedColumns`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const columns = data.data;
                        let html = '<h4>支持的Excel列名（共' + columns.length + '个）：</h4><ul>';
                        columns.forEach(column => {
                            html += `<li>${column}</li>`;
                        });
                        html += '</ul>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="error">加载失败：' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    console.error('加载支持的列名失败:', error);
                    container.innerHTML = '<div class="error">加载失败：' + error.message + '</div>';
                });
        }

        // 导入Excel文件
        function importExcel() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('importResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">请先选择Excel文件</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDiv.innerHTML = '<div class="info">正在导入Excel文件，请稍候...</div>';

            fetch(`${API_BASE}/importExcelWithMapping`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.data;
                    let html = '<div class="success">导入成功！</div>';
                    html += '<table>';
                    html += '<tr><th>项目</th><th>数量</th></tr>';
                    html += `<tr><td>总计</td><td>${result.totalCount || 0}</td></tr>`;
                    html += `<tr><td>成功</td><td>${result.successCount || 0}</td></tr>`;
                    html += `<tr><td>失败</td><td>${result.errorCount || 0}</td></tr>`;
                    html += '</table>';

                    // 显示错误信息
                    if (result.readErrorMessages && result.readErrorMessages.length > 0) {
                        html += '<h4>读取错误信息：</h4>';
                        html += '<div class="result-details">';
                        result.readErrorMessages.forEach(msg => {
                            html += `<p>• ${msg}</p>`;
                        });
                        html += '</div>';
                    }

                    if (result.saveErrorMessages && result.saveErrorMessages.length > 0) {
                        html += '<h4>保存错误信息：</h4>';
                        html += '<div class="result-details">';
                        result.saveErrorMessages.forEach(msg => {
                            html += `<p>• ${msg}</p>`;
                        });
                        html += '</div>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">导入失败：' + data.message + '</div>';
                }
            })
            .catch(error => {
                console.error('导入失败:', error);
                resultDiv.innerHTML = '<div class="error">导入失败：' + error.message + '</div>';
            });
        }

        // 创建示例Excel文件说明
        function createSampleExcel() {
            const resultDiv = document.getElementById('importResult');
            
            let html = '<div class="info">';
            html += '<h4>示例Excel文件格式：</h4>';
            html += '<p>请创建一个Excel文件，包含以下列名（可以选择其中任意几列）：</p>';
            html += '<table>';
            html += '<tr><th>列名示例</th><th>对应字段</th><th>数据类型</th><th>说明</th></tr>';
            html += '<tr><td>样品名称 / 植物名称 / 名称</td><td>name</td><td>文本</td><td>必填</td></tr>';
            html += '<tr><td>数值 / 值 / 测量值</td><td>value</td><td>数字</td><td>可选</td></tr>';
            html += '<tr><td>批次 / 批次号 / 批号</td><td>batch</td><td>整数</td><td>必填</td></tr>';
            html += '<tr><td>类别 / 分类 / 类型</td><td>type</td><td>文本</td><td>可选</td></tr>';
            html += '<tr><td>第1分钟 / 时间1 / T1 / 1分钟</td><td>time1</td><td>整数</td><td>可选</td></tr>';
            html += '<tr><td>第2分钟 / 时间2 / T2 / 2分钟</td><td>time2</td><td>整数</td><td>可选</td></tr>';
            html += '<tr><td>... (支持到time88)</td><td>...</td><td>整数</td><td>可选</td></tr>';
            html += '</table>';
            html += '<p><strong>示例数据：</strong></p>';
            html += '<table>';
            html += '<tr><th>样品名称</th><th>批次</th><th>类别</th><th>第1分钟</th><th>第2分钟</th><th>第3分钟</th></tr>';
            html += '<tr><td>人参</td><td>1</td><td>中药材</td><td>10</td><td>15</td><td>20</td></tr>';
            html += '<tr><td>当归</td><td>1</td><td>中药材</td><td>8</td><td>12</td><td>18</td></tr>';
            html += '<tr><td>黄芪</td><td>2</td><td>中药材</td><td>12</td><td>18</td><td>25</td></tr>';
            html += '</table>';
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }

        // 页面加载时自动加载支持的列名
        window.onload = function() {
            loadSupportedColumns();
        };
    </script>
</body>
</html>
